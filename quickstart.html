<html>

<head>
    <meta charset="UTF-8">
    <title>Video测试页面</title>
</head>

<body style="background:#333;color:#fff;text-align: center;">
    <div id="current-invite" hidden="" style="z-index: 999; position:absolute;border: 1px solid;border-radius: 5px; width:320px;height:160px;left:50%;margin-left:-160px;background-color: white;margin-top: 200px; ">
        <div id="invitInfo" style="width:300px;height:60px;color:black;padding-top:40px;">
        </div>
        <button style="height:30px;border: 1px solid;border-radius:3px;width:100px;cursor:pointer;" onclick="accept()">
            接受
        </button>
        <button style="height:30px;border: 1px solid;border-radius:3px;width:100px;margin-left:20px;cursor:pointer;" onclick="reject()">
            拒绝
        </button>
    </div>
    <div style="text-align:center;font-size:50px;margin-top:50px;">wilddog video quickstart</div>
    <div id="getAppid-div" style="text-align:center;margin-top:150px;">
        <input id="appid" onfocus='hiddenTip()' type="" style="width:200px;height:35px;" name="" placeholder='请输入应用 ID'>
        <input id="path" onfocus='hiddenTip()' type="" style="width:200px;height:35px;" name="" placeholder='请输入控制面板设置的交互路径'>
        <button id="login" onclick="login()" style="height:35px;border: 1px solid;border-radius: 3px;cursor:pointer">匿名登录</button>
        <i id="appid-tip" style="position:absolute;margin-top:40px;margin-left:-480px;font-size:15px;color:#eb3232;" hidden=""></i>
    </div>
    <div id="videos" style="text-align:center;margin:0px auto;margin-top:60px;" hidden="">
        <video id="local" style="border:1px solid;width:480px;height:360px;margin-top:20px;" muted="" autoplay=""></video>
        <video id="remote" style="border:1px solid;width:480px;height:360px;margin-left:50px;margin-top:20px;" autoplay="" hidden></video>
    </div>
    <div id="appid-text" style="margin-top:20px;"></div>
    <div id="hangup" style="height:50px;;text-align:center;margin-top:20px;" hidden="">
        <button style="height:35px;border: 1px solid;border-radius: 3px;width:200px;cursor:pointer; " onclick="disconnect()">挂断</button>
    </div>
    <div id="users" style="margin:0 auto;margin-top:40px;width:300px;" hidden="">
        <div style="margin:0 auto;text-align:center;font-size:20px;margin-bottom:30px;">可邀请的在线用户列表</div>
        <div id="user-list" style="border:1px solid;float:left;width:100%;min-height:200px;">
            <div id="user-model" style="background-color:white; color: black; width:280px;height:30px;border:1px solid;margin:10px;float:left;" hidden="">
                <span class="remoteuid"></span>
                <button style="margin-top: 3px;border: 1px solid;border-radius: 3px;cursor:pointer " onclick="invite(this.parentElement.id)">邀请</button>
            </div>
        </div>
    </div>
    <script type="text/javascript" src='https://cdn.wilddog.com/sdk/js/2.0.0/wilddog.js'></script>
    <script type="text/javascript" src='https://cdn.wilddog.com/sdk/js/0.4.2/wilddog-video.js'></script>
    <script type="text/javascript">
    /*
     * demo设计思路总览：
     * 分析、准备阶段：
     *      从wilddog.Video的API来看，我们能够获取一个Conversation中的有哪些用户
     *     ，但却无法获取Conversation之外有哪些用户（这些用户并不是仅包括尚未加
     *     入任何会议的用户，wilddog.Video Web SDK 支持一个用户同时加入多个会议
     *     ），因此我们需要单独保存一个users 列表，用来保存在线的用户，以便与其
     *     他用户进行会话。
     *     注：使用野狗中转服务时，在交互路径下也存在
     *     conversations/conversationId/users节点，此节点与我们demo中的users节点
     *     并无关系，交互路径下的节点用于保障中转服务的正常使用，设计初衷并不是
     *     提供给用户使用，因此应尽量避免使用交互路径下的数据。
     * demo设计阶段：
     *     此demo计划使用野狗的中转服务模式来完成。
     * demo实现步骤：
     *     1.输入野狗的appId和在控制面板的服务器中转页面设置的交互路径，然后
     *     匿名登录。
     *     2.匿名登录后，将用户写在users节点下（非交互路径，修改交互路径下的数据
     *     极有可能影响正常功能的使用）。
     *     3.客户端监听users节点，用于获取当前在线用户，方便发送会话邀请。当前在
     *     线用户会出现在页面的‘可邀请在线用户列表中’。
     *     4.选择一个在线用户，发出邀请。
     *     5.对方拒绝邀请。
     *     6.对方接受邀请，双方先在users节点下将自己的UID删除。（demo以实现基本
     *     功能为初衷，因此暂不支持一个用户可以加入多个Conversation的情况。）
     *     7.在本方发出邀请之后，可以拿到Conversation对象，Conversation提供了监
     *     听用户加入和离开的事件，当有用户加入时：创建一个video标签用于播放其媒
     *     体流。当有用户离开时，可以根据participantId来删除对应的video
     * wilddog.video SDK使用步骤：
     *     1.通过wilddog.video()获取Video对象。注：页面中必须要引wilddog.js和
     *     wilddog-video.js
     *     2.Video.client()获取Client对象。发起或加入会话依赖Client。
     *     3.Client.init(),init()主要作用为连接野狗服务端，因此其他函数的调用必
     *     须在init()完成后来执行的。
     *     4.（1）主动邀请：
     *          调用client.inviteToConversation()
     *       （2）接受邀请：
     *          监听client的invite事件收到邀请，并拿到incomingInvite对象
     * 更多详细API请参考wilddog.video文档：
     *     https://itolfh.gitbooks.io/video/content/
     */

    //获取所使用到的所有元素
    var localEl = document.getElementById('local');
    var remoteEl = document.getElementById('remote');
    var appidEl = document.getElementById('appid');
    var pathEl = document.getElementById('path');
    var userModel = document.getElementById('user-model');
    var userDiv = document.getElementById('users');
    var userList = document.getElementById('user-list');
    var videoList = document.getElementById('videos');
    var hangupEl = document.getElementById('hangup');
    var loginBtn = document.getElementById('login');
    var errTip = document.getElementById('appid-tip');
    var appidText = document.getElementById('appid-text');
    var invitInfo = document.getElementById('invitInfo');
    var inviteEl = document.getElementById('current-invite');
    var loginDiv = document.getElementById('getAppid-div');
    //隐藏appId错误提示
    var hiddenTip = function() {
        errTip.hidden = true;
    }

    var currentConversation = null;
    var wilddogref = null;
    var usersRef = null;
    var auth = null;

    var remoteStream = null;

    var currentInvite = null;

    var outInvite = null;

    //获取Video对象
    var videoInstance = wilddog.video();
    //获取Client对象
    var clientInstance = videoInstance.client();

    var localStream = null;

    //登录
    //注：()=>{} ES6语法的匿名函数定义，其变化为：如果函数内部出现this，指代全局的this，而不再是函数的调用者
    var login = function() {
        if (!appid.value || !pathEl.value) {
            errTip.textContent = '请输入appId和交互路径！';
            errTip.hidden = false;
            return;
        };
        //初始化野狗
        var config = {
            authDomain: appidEl.value + '.wilddog.com',
            syncURL: "https://" + appid.value + ".wilddogio.com/" + pathEl.value
        };

        wilddog.initializeApp(config);
        //定义wilddog.video交互路径
        wilddogref = wilddog.sync().ref();
        //定义quickstart使用的用户列表存储路径
        usersRef = wilddog.sync().ref();
        //野狗匿名登录
        wilddog.auth().signInAnonymously()
            .then((user) => {
                //获取本地媒体流，并绑定到页面
                videoInstance.createStream({
                        audio: true,
                        video: 'low'
                    })
                    .then(function(wdStream) {
                        localStream = wdStream;
                        localStream.attach(localEl);
                    })
                    .catch(function(err) {
                        console.error(err);
                    })

                //页面操作，无关sdk
                appidText.textContent = '你的Wilddog ID：' + user.uid;
                loginDiv.hidden = true;
                videoList.hidden = false;
                userDiv.hidden = false;

                loginBtn.disabled = true;
                auth = user;

                //SDK之外保存的一个在线用户列表，匿名成功之后写入列表，列表中的用户均是可邀请和可被邀请的用户，如用户发出邀请或接受邀请后都需在列表中将自己暂时删除，结束会话后再写入用户列表
                usersRef.child('users/' + user.uid).set(true);
                usersRef.child('users/' + user.uid).onDisconnect().remove();

                //Client初始化操作，执行必须在匿名登录之后进行，client的其他函数必须在init成功后才可调用
                clientInstance.init({
                        ref: wilddogref,
                        user: user
                    })
                    .then(() => {
                        //监听收到的邀请
                        clientInstance.on('invite', (incomingInvite) => {
                            currentInvite = incomingInvite;
                            inviteEl.hidden = false;
                            invitInfo.textContent = incomingInvite.from + '向你发出会话邀请'
                                //监听邀请者的取消邀请事件
                            incomingInvite.on('canceled', () => {
                                currentInvite = null;
                                inviteEl.hidden = true;
                            })
                        });
                    });

                //监听在线用户列表
                usersRef.child('users').on('child_added', (snap) => {
                    if (snap.key() != user.uid) {
                        var newUser = userModel.cloneNode(true);
                        newUser.id = snap.key();
                        newUser.children[0].textContent = snap.key();
                        newUser.hidden = false;
                        userList.appendChild(newUser);
                    }
                });

                usersRef.child('users').on('child_removed', (snap) => {
                    if (snap.key() != user.uid) {
                        var removeEl = document.getElementById(snap.key());
                        userList.removeChild(removeEl);
                    }
                })

            }).catch(function(err) {
                errTip.textContent = '请检查appid是否正确并开启匿名登录功能！';
                errTip.hidden = false;
            });
    }

    //接受当前收到的邀请
    var accept = function() {
        currentInvite.accept(localStream)
            .then((conversation) => {
                console.log('accept');

                inviteEl.hidden = true;

                currentConversation = conversation;
                hangupEl.hidden = false;

                // userDiv.hidden = true;

                //在线用户列表只保存也被邀请和可邀请他人的用户，因此接受邀请后即在用户列表中将自己删除，防止其他用户再邀请
                usersRef.child('users/' + auth.uid).remove();

                //监听新参与者加入conversation
                conversation.on('participant_connected', (participant) => {
                    var newRemote = remote.cloneNode(true);
                    newRemote.id = participant.participantId;
                    newRemote.hidden = false;
                    videoList.appendChild(newRemote);
                    participant.stream.attach(newRemote);
                });
                //监听会话参与者的断开事件
                conversation.on('participant_disconnected', (participant) => {
                    var removeEl = document.getElementById(participant.participantId);
                    participant.stream.detach(removeEl);
                    videoList.removeChild(removeEl);
                    console.log(participant.participantId);
                    console.log('participant_disconnected');
                });
            });
    };

    //拒绝当前收到的邀请
    var reject = function() {
        currentInvite.reject();
        inviteEl.hidden = true;
    }

    //邀请其他用户加入会话  
    var invite = function(uid) {
        console.log(uid);

        //如果尚未加入任何Conversation，则调用client.inviteToConversation
        //已经加入了一个Conversation，则调用conversation.invite
        if (!currentConversation) {
            console.log('inviteToConversation');
            outInvite = clientInstance.inviteToConversation({
                'mode': 'server_based',
                'participantId': uid,
                'localStream': localStream,
            })

            //发出邀请后可以在.then()中获取conversation
            outInvite.then((conversation) => {

                currentConversation = conversation;

                //监听新参与者加入conversation
                conversation.on('participant_connected', (participant) => {
                    var newRemote = remote.cloneNode(true);
                    newRemote.id = participant.participantId;
                    newRemote.hidden = false;
                    videoList.appendChild(newRemote);
                    participant.stream.attach(newRemote);
                });

                //监听参与者离开conversation
                conversation.on('participant_disconnected', (participant) => {
                    var removeEl = document.getElementById(participant.participantId);
                    participant.stream.detach(removeEl);
                    videoList.removeChild(removeEl);
                    console.log(participant.participantId);
                    console.log('participant_disconnected');
                });
            });

            //监听被邀请者的接受邀请的事件
            outInvite.on('accepted', () => {
                usersRef.child('users/' + auth.uid).remove();
                hangupEl.hidden = false;
                // userDiv.hidden = true;
            })

            //监听被邀请者的拒绝邀请的事件
            outInvite.on('rejected', () => {
                currentConversation = null;
                hangupEl.hidden = true;
                // userDiv.hidden = false;
            })
        } else {
            console.log('conversation.invite');
            currentConversation.invite(uid);
        }
    }

    //离开当前conversation
    var disconnect = function() {
        if (currentConversation) {
            //Conversation提供了disconnect函数用于主动离开conversation
            currentConversation.disconnect();
            for (var i = videoList.children.length - 1; i >= 2; i--) {
                videoList.removeChild(videoList.children[i]);
            }
            hangup.hidden = true;
            currentConversation = null;
            // userDiv.hidden = false;
            usersRef.child('users/' + auth.uid).set(true);
        }
    }
    </script>
</body>

</html>
